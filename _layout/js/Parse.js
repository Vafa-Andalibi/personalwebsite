(function(k){function l(){this.months="jan feb mar apr may jun jul aug sep oct nov dec".split(" ");this.notKey=[",","{","}"," ","="];this.pos=0;this.input="";this.entries=[];this.currentEntry="";this.setInput=function(a){this.input=a};this.getEntries=function(){return this.entries};this.isWhitespace=function(a){return" "==a||"\r"==a||"\t"==a||"\n"==a};this.match=function(a,b){if(void 0==b||null==b)b=!0;this.skipWhitespace(b);if(this.input.substring(this.pos,this.pos+a.length)==a)this.pos+=a.length;
    else throw TypeError("Token mismatch: match","expected "+a+", found "+this.input.substring(this.pos));this.skipWhitespace(b)};this.tryMatch=function(a,b){if(void 0==b||null==b)b=!0;this.skipWhitespace(b);return this.input.substring(this.pos,this.pos+a.length)==a?!0:!1};this.matchAt=function(){for(;this.input.length>this.pos&&"@"!=this.input[this.pos];)this.pos++;return"@"==this.input[this.pos]?!0:!1};this.skipWhitespace=function(a){for(;this.isWhitespace(this.input[this.pos]);)this.pos++;if("%"==
    this.input[this.pos]&&1==a){for(;"\n"!=this.input[this.pos];)this.pos++;this.skipWhitespace(a)}};this.value_braces=function(){var a=0;this.match("{",!1);for(var b=this.pos,c=!1;;){if(!c)if("}"==this.input[this.pos])if(0<a)a--;else return a=this.pos,this.match("}",!1),this.input.substring(b,a);else if("{"==this.input[this.pos])a++;else if(this.pos>=this.input.length-1)throw TypeError("Unterminated value: value_braces");c="\\"==this.input[this.pos]&&0==c?!0:!1;this.pos++}};this.value_comment=function(){for(var a=
    "",b=0;!this.tryMatch("}",!1)||0!=b;){a+=this.input[this.pos];"{"==this.input[this.pos]&&b++;"}"==this.input[this.pos]&&b--;if(this.pos>=this.input.length-1)throw TypeError("Unterminated value: value_comment",+this.input.substring(start));this.pos++}return a};this.value_quotes=function(){this.match('"',!1);for(var a=this.pos,b=!1;;){if(!b){if('"'==this.input[this.pos])return b=this.pos,this.match('"',!1),this.input.substring(a,b);if(this.pos>=this.input.length-1)throw TypeError("Unterminated value: value_quotes",
    this.input.substring(a));}b="\\"==this.input[this.pos]&&0==b?!0:!1;this.pos++}};this.single_value=function(){var a=this.pos;if(this.tryMatch("{"))return this.value_braces();if(this.tryMatch('"'))return this.value_quotes();var b=this.key();if(b.match("^[0-9]+$"))return b;if(0<=this.months.indexOf(b.toLowerCase()))return b.toLowerCase();throw"Value expected: single_value"+this.input.substring(a)+" for key: "+b;};this.value=function(){var a=[];for(a.push(this.single_value());this.tryMatch("#");)this.match("#"),
    a.push(this.single_value());return a.join("")};this.key=function(a){for(var b=this.pos;;){if(this.pos>=this.input.length)throw TypeError("Runaway key: key");if(0<=this.notKey.indexOf(this.input[this.pos]))return a&&","!=this.input[this.pos]?(this.pos=b,null):this.input.substring(b,this.pos);this.pos++}};this.key_equals_value=function(){var a=this.key();if(this.tryMatch("=")){this.match("=");var b=this.value();a=a.trim();return[a,b]}throw TypeError("Value expected, equals sign missing: key_equals_value",
    this.input.substring(this.pos));};this.key_value_list=function(){var a=this.key_equals_value();this.currentEntry.entryTags={};for(this.currentEntry.entryTags[a[0]]=a[1];this.tryMatch(",");){this.match(",");if(this.tryMatch("}"))break;a=this.key_equals_value();this.currentEntry.entryTags[a[0]]=a[1]}};this.entry_body=function(a){this.currentEntry={};this.currentEntry.citationKey=this.key(!0);this.currentEntry.entryType=a.substring(1);null!=this.currentEntry.citationKey&&this.match(",");this.key_value_list();
    this.entries.push(this.currentEntry)};this.directive=function(){this.match("@");return"@"+this.key()};this.preamble=function(){this.currentEntry={};this.currentEntry.entryType="PREAMBLE";this.currentEntry.entry=this.value_comment();this.entries.push(this.currentEntry)};this.comment=function(){this.currentEntry={};this.currentEntry.entryType="COMMENT";this.currentEntry.entry=this.value_comment();this.entries.push(this.currentEntry)};this.entry=function(a){this.entry_body(a)};this.alernativeCitationKey=
    function(){this.entries.forEach(function(a){!a.citationKey&&a.entryTags&&(a.citationKey="",a.entryTags.author&&(a.citationKey+=a.entryTags.author.split(",")[0]+=", "),a.citationKey+=a.entryTags.year)})};this.bibtex=function(){for(;this.matchAt();){var a=this.directive();this.match("{");"@STRING"==a.toUpperCase()?this.string():"@PREAMBLE"==a.toUpperCase()?this.preamble():"@COMMENT"==a.toUpperCase()?this.comment():this.entry(a);this.match("}")}this.alernativeCitationKey()}}k.toJSON=function(a){var b=
    new l;b.setInput(a);b.bibtex();return b.entries};k.toBibtex=function(a,b){void 0===b&&(b=!0);var c="",f=",",g="";b||(f=",\n",g="    ");for(var d in a){c+="@"+a[d].entryType;c+="{";a[d].citationKey&&(c+=a[d].citationKey+f);a[d].entry&&(c+=a[d].entry);if(a[d].entryTags){var e=g,h;for(h in a[d].entryTags)0!=e.trim().length&&(e+=f+g),e+=h+(b?"={":" = {")+a[d].entryTags[h]+"}";c+=e}c+=b?"}\n":"\n}\n\n"}return c}})("undefined"===typeof exports?this.bibtexParse={}:exports);